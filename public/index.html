<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PatrolWA - Patroli WhatsApp</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <style>
      .loading-indicator {
        display: none;
      }
      .uploading .loading-indicator {
        display: block;
      }
      #imageContainer {
        max-width: 30%;
        height: auto;
        margin: 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #imageContainer img {
        max-width: 100%;
        height: auto;
        border: 2px solid #ccc;
        border-radius: 8px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      }

      .form-container {
        max-width: 400px;
        margin: 10px auto;
        padding: 20px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      }
      .form-container input[type="text"],
      .form-container button {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .form-container button {
        background-color: #2563eb;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .form-container button:hover {
        background-color: #1e4bb0;
      }
    </style>
  </head>
  <body class="bg-gray-100 h-screen flex flex-col items-center">
    <div id="imageContainer" class="mb-8"></div>
    <div class="loading-indicator text-blue-500 font-bold py-2 px-4 rounded">
      Mengunggah...
    </div>

    <input
      type="file"
      id="fileInput"
      accept="image/*"
      capture="camera"
      class="hidden"
      value=""
    />
    <label
      for="fileInput"
      class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded cursor-pointer mb-4"
      ><i class="fa-solid fa-camera"></i
    ></label>

    <div class="form-container">
      <form name="submit-to-google-sheet" class="mt-4">
        <input
          type="text"
          name="Foto"
          id="imageUrlInput"
          placeholder="URL Gambar"
          class="mb-4"
          value="-"
          hidden
        />
        <div class="mb-4">
          <select
            id="petugasSelect"
            name="Petugas"
            class="block w-full bg-white border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500"
          ></select>
        </div>
        <input
          name="Keterangan"
          type="textarea"
          placeholder="Keterangan"
          required
          class="mb-4 appearance-none block w-full bg-white border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500"
        />
        <button
          type="submit"
          id="submitBtn"
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center"
        >
          <span id="submitBtnText">Kirim</span>
          <svg
            id="loadingSpinner"
            class="animate-spin h-5 w-5 ml-3 hidden"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6v6m0 0v6m0-6h6m-6 0H6"
            ></path>
          </svg>
        </button>
      </form>
    </div>
    <script>
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbzLAqrB3EDuOomueHyZFPaPQy2OfVnvbsyBABPCMYe9Hf4Loqsh-LYlaXOMApQEs8eI4Q/exec";
      const form = document.forms["submit-to-google-sheet"];

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const imageUrl = imageUrlInput.value;
        const keterangan = form.elements["Keterangan"].value;
        const nomorWhatsApp = petugasSelect.value;

        if (!keterangan) {
          alert("Mohon lengkapi keterangan.");
          return;
        }
        const caption = `⚠️ *LAPORAN BARU* ⚠️
%0A%0A*Keterangan:* ${keterangan}%0A%0A*Petugas:* ${nomorWhatsApp}`;
        try {
          let response;

          if (imageUrl) {
            response = await fetch(
              `https://otp.ilsya.my.id/api/send-message?receiver=120363256542098102@g.us&apikey=112233&mtype=image&url=${imageUrl}&text=${caption}`,
            );
          } else {
            response = await fetch(
              `https://otp.ilsya.my.id/api/send-message?receiver=120363256542098102@g.us&apikey=112233&mtype=text&text=${caption}`,
            );
          }

          if (response.ok) {
            // showAlert("Sukses!", "Pesan WhatsApp berhasil dikirim.");
            form.reset();
            imageContainer.innerHTML = "";
          } else {
            throw new Error("Gagal mengirim pesan WhatsApp.");
          }
        } catch (error) {
          console.error("Error!", error.message);
          showAlert(
            "Error!",
            "Terjadi kesalahan saat mengirim pesan WhatsApp.",
          );
        }
      });

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtnText.classList.add("hidden");
        loadingSpinner.classList.remove("hidden");

        fetch(scriptURL, { method: "POST", body: new FormData(form) })
          .then((response) => {
            if (response.ok) {
              showAlert("Sukses!", "Data berhasil dikirim.");
              form.reset();
              imageContainer.innerHTML = "";
            } else {
              throw new Error("Gagal mengirim data");
            }
          })
          .catch((error) => {
            console.error("Error!", error.message);
            showAlert("Error!", "Terjadi kesalahan saat mengirim data.");
          })
          .finally(() => {
            submitBtn.disabled = false;
            submitBtnText.classList.remove("hidden");
            loadingSpinner.classList.add("hidden");
          });
      });

      function showAlert(title, message) {
        Swal.fire({
          icon: "success",
          title: title,
          text: message,
          timer: 2000,
          timerProgressBar: true,
          showConfirmButton: false,
        });
      }

      const imageContainer = document.getElementById("imageContainer");
      const fileInput = document.getElementById("fileInput");
      const loadingIndicator = document.querySelector(".loading-indicator");

      fileInput.addEventListener("change", async () => {
        try {
          const file = fileInput.files[0];
          if (!file) {
            alert("Pilih gambar terlebih dahulu!");
            return;
          }
          loadingIndicator.classList.add("uploading");
          const compressedFile = await compressImage(file);

          const formData = new FormData();
          formData.append("image", compressedFile);

          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            const imageUrl = await response.text();
            imageContainer.innerHTML = `<img src="${imageUrl}" alt="Uploaded Image">`;
            imageUrlInput.value = imageUrl;
          } else {
            throw new Error("Gagal mengunggah gambar");
          }
        } catch (error) {
          console.error("Terjadi kesalahan:", error);
          alert("Terjadi kesalahan saat mengunggah gambar");
        } finally {
          loadingIndicator.classList.remove("uploading");
        }
      });

      function compressImage(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");
              canvas.width = img.width;
              canvas.height = img.height;
              ctx.drawImage(img, 0, 0);
              canvas.toBlob(
                (blob) => {
                  resolve(
                    new File([blob], file.name, {
                      type: "image/jpeg",
                      lastModified: Date.now(),
                    }),
                  );
                },
                "image/jpeg",
                0.1,
              ); // Kualitas kompresi (0.5 untuk setengahnya)
            };
          };
          reader.onerror = (error) => reject(error);
          reader.readAsDataURL(file);
        });
      }
    </script>

    <script>
      async function fetchDataAndDisplay() {
        try {
          const response = await fetch("/api/data");
          const data = await response.json();

          const petugasSelect = document.getElementById("petugasSelect");

          petugasSelect.innerHTML =
            "<option value=''>-- Pilih Petugas --</option>";

          data.forEach((petugas) => {
            const option = document.createElement("option");
            option.text = petugas.namaPetugas;
            option.value = petugas.namaPetugas;
            petugasSelect.add(option);
          });
        } catch (error) {
          console.error("Error:", error);
          const errorMessage = document.createElement("p");
          errorMessage.textContent = "Gagal mengambil data petugas.";
          document.body.appendChild(errorMessage);
        }
      }

      fetchDataAndDisplay();

      document
        .getElementById("petugasSelect")
        .addEventListener("change", function () {
          document.getElementById("waInput").value = this.value;
        });
    </script>
  </body>
</html>

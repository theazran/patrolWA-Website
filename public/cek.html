<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PatrolWA - Patroli WhatsApp</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="manifest" href="/manifest.json" />
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      #imageContainer img {
        max-width: 30%;
        height: auto;
        border: 10px solid #ccc;
        border-radius: 8px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      }

      html {
        position: relative;
        min-height: 100%;
      }
      body {
        margin-bottom: 60px; /* Margin bottom equal to footer height */
      }
      .footer {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 60px; /* Height of the footer */
        background-color: #f5f5f5;
      }
    </style>
  </head>
  <body class="bg-gray-100 h-screen dark" data-bs-scheme="dark">
    <nav class="navbar bg-body-tertiary shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img
            src="https://imgdb.net/storage/uploads/a461f4ba9c9f1f40f9d98c069a8ea5d4b089acf945e0bbeadcd3e13fbafdc21f.png"
            alt="Logo"
            width="100"
            class="d-inline-block align-text-top"
          />
        </a>
      </div>
    </nav>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div>
            <div class="alert alert-danger" role="alert">
              HALAMAN TESTING PAGE
            </div>
          </div>
          <div id="offline-message" style="display: none">
            <div class="alert alert-danger" role="alert">
              Anda sedang offline. Silakan cek koneksi internet Anda.
            </div>
          </div>
          <div id="imageContainer" class="mb-4 text-center"></div>
          <div
            class="loading-indicator btn btn-none btn-small mb-4"
            style="display: none"
          >
            <i
              class="fa-solid fa-2x text-secondary fa-cloud-arrow-up fa-bounce"
            ></i>
          </div>
          <input
            type="file"
            id="fileInput"
            accept="image/*"
            capture="camera"
            class="d-none"
          />
          <div class="card mb-2">
            <div class="card-body shadow-sm">
              <form name="submit-to-google-sheet">
                <div class="d-grid gap-2 col-6 mx-auto">
                  <label for="fileInput" class="btn btn-primary btn-block mb-2"
                    ><i class="fas fa-camera"></i> Unggah Gambar</label
                  >
                </div>
                <input
                  type="text"
                  name="Foto"
                  id="imageUrlInput"
                  placeholder="URL Gambar"
                  value="-"
                  hidden
                />
                <div class="form-group">
                  <select
                    id="petugasSelect"
                    name="Petugas"
                    class="form-control mb-2"
                  >
                    <option value="-">-- Pilih Petugas --</option>
                  </select>
                </div>
                <div class="form-group">
                  <textarea
                    name="Keterangan"
                    placeholder="Masukkan laporan"
                    class="form-control mb-2"
                    rows="3"
                    required
                  ></textarea>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <button
                    type="submit"
                    id="submitBtn"
                    class="btn btn-primary btn-block"
                  >
                    <span id="submitBtnText"
                      ><i class="fa-solid fa-paper-plane"></i> Kirim</span
                    >
                    <span
                      id="loadingSpinner"
                      class="spinner-border hidden spinner-border-sm ml-2"
                      role="status"
                      aria-hidden="true"
                      style="display: none"
                    ></span>
                  </button>
                </div>
              </form>
            </div>
          </div>
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Laporan terakhir</h5>
              <p class="card-text" id="latestKeterangan">-</p>
              <p class="card-text">
                <small class="text-body-secondary" id="latestTime"></small> -
                <span class="badge text-bg-warning"
                  ><small class="" id="latestPetugas">Loading...</small></span
                >
              </p>
            </div>
          </div>
          <script>
            fetch("/package")
              .then((response) => response.json())
              .then((data) => {
                document.getElementById("packageData").textContent =
                  data.name + " - " + "v" + data.version;
                document.getElementById("nama").textContent =
                  "Made with ❤️ by " + data.author;
              })
              .catch((error) => {
                console.error("Error fetching package.json:", error);
              });
          </script>

          <script>
            function fetchLatestData() {
              $.ajax({
                url: "https://opensheet.elk.sh/1kwsvHO00ZOZj3kJ-MkFeJSNzy0k0EfKHpU8X8RlOv8M/Sheet1",
                method: "GET",
                success: function (data) {
                  var latestData = data[data.length - 1];
                  $("#latestKeterangan").text(latestData.Keterangan);
                  $("#latestTime").text(latestData.timestamp);
                  $("#latestPetugas").text(latestData.Petugas);
                },
                error: function (xhr, status, error) {
                  console.error("Terjadi kesalahan:", error);
                },
              });
            }

            $(document).ready(function () {
              fetchLatestData();
              setInterval(fetchLatestData, 3000);
            });
          </script>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <!-- Your custom script -->
    <script>
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbzLAqrB3EDuOomueHyZFPaPQy2OfVnvbsyBABPCMYe9Hf4Loqsh-LYlaXOMApQEs8eI4Q/exec";
      const form = document.forms["submit-to-google-sheet"];

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const imageUrl = imageUrlInput.value;
        const keterangan = form.elements["Keterangan"].value;
        const nomorWhatsApp = petugasSelect.value;

        if (!keterangan) {
          alert("Mohon lengkapi keterangan.");
          return;
        }
        const caption = `⚠️ *LAPORAN BARU* ⚠️
  %0A%0A*Laporan:*%0A${keterangan}%0A%0A*Petugas:* ${nomorWhatsApp}`;
        try {
          let response;

          loadingSpinner.classList.remove("hidden");

          submitBtn.disabled = true;

          if (imageUrl != "-") {
            response = await fetch(
              `https://wa.notifku.my.id/api/send-message?receiver=120363230010661540@g.us&apikey=patrolwa1&mtype=image&url=${imageUrl}&text=${caption}`
            );
          } else {
            response = await fetch(
              `https://wa.notifku.my.id/api/send-message?receiver=120363230010661540@g.us&apikey=patrolwa1&mtype=text&text=${caption}`
            );
          }

          if (response.ok) {
            // showAlert("Sukses!", "Pesan WhatsApp berhasil dikirim.");
            form.reset();
            imageContainer.innerHTML = "";
          } else {
            throw new Error("Gagal mengirim pesan WhatsApp.");
          }
        } catch (error) {
          console.error("Error!", error.message);
          showAlert(
            "Error!",
            "Terjadi kesalahan saat mengirim pesan WhatsApp."
          );
        }
      });

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtnText.classList.add("hidden");
        loadingSpinner.classList.remove("hidden");
        fetch(scriptURL, { method: "POST", body: new FormData(form) })
          .then((response) => {
            if (response.ok) {
              showAlert("Sukses!", "Data berhasil dikirim.");
              form.reset();
              imageContainer.innerHTML = "";
            } else {
              throw new Error("Gagal mengirim data");
            }
          })
          .catch((error) => {
            console.error("Error!", error.message);
            showAlert("Error!", "Terjadi kesalahan saat mengirim data.");
          })
          .finally(() => {
            submitBtn.disabled = false;
            submitBtnText.classList.remove("hidden");
            loadingSpinner.classList.add("hidden");
          });
      });

      function showAlert(title, message) {
        Swal.fire({
          icon: "success",
          title: title,
          text: message,
          timer: 2000,
          timerProgressBar: true,
          showConfirmButton: false,
        });
      }

      const imageContainer = document.getElementById("imageContainer");
      const fileInput = document.getElementById("fileInput");
      const loadingIndicator = document.querySelector(".loading-indicator");

      fileInput.addEventListener("change", async () => {
        try {
          const file = fileInput.files[0];
          loadingIndicator.style.display = "block";
          const compressedFile = await compressImage(file);
          const formData = new FormData();
          formData.append("image", compressedFile);
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          loadingIndicator.style.display = "none";

          if (response.ok) {
            const imageUrl = await response.text();
            imageContainer.innerHTML = `<img src="${imageUrl}" alt="Uploaded Image">`;
            imageUrlInput.value = imageUrl;
          } else {
            throw new Error("Gagal mengunggah gambar");
          }
        } catch (error) {
          console.error("Terjadi kesalahan:", error);
          alert("Terjadi kesalahan saat mengunggah gambar");
          loadingIndicator.style.display = "none";
        }
      });

      function compressImage(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");
              canvas.width = img.width;
              canvas.height = img.height;
              ctx.drawImage(img, 0, 0);
              canvas.toBlob(
                (blob) => {
                  resolve(
                    new File([blob], file.name, {
                      type: "image/jpeg",
                      lastModified: Date.now(),
                    })
                  );
                },
                "image/jpeg",
                0.1
              ); // Kualitas kompresi (0.5 untuk setengahnya)
            };
          };
          reader.onerror = (error) => reject(error);
          reader.readAsDataURL(file);
        });
      }
    </script>

    <script>
      async function fetchDataAndDisplay() {
        try {
          const response = await fetch("/api/data");
          const data = await response.json();

          const petugasSelect = document.getElementById("petugasSelect");

          petugasSelect.innerHTML =
            "<option value=''>-- Pilih Petugas --</option>";

          data.forEach((petugas) => {
            const option = document.createElement("option");
            option.text = petugas.namaPetugas;
            option.value = petugas.namaPetugas;
            petugasSelect.add(option);
          });
        } catch (error) {
          console.error("Error:", error);
          const errorMessage = document.createElement("p");
          errorMessage.textContent = "";
          document.body.appendChild(errorMessage);
        }
      }

      fetchDataAndDisplay();

      document
        .getElementById("petugasSelect")
        .addEventListener("change", function () {
          document.getElementById("waInput").value = this.value;
        });
    </script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/serviceworker.js")
            .then((registration) => {
              console.log("Service Worker registered:", registration);
            })
            .catch((error) => {
              console.log("Service Worker registration failed:", error);
            });
        });
      }

      if (!navigator.onLine) {
        document.getElementById("offline-message").style.display = "block";
        document.getElementById("app").style.display = "none";
      }
    </script>
    <footer class="footer">
      <div class="container">
        <span class="text-muted" id="packageData"></span>
        <br />
        <small id="nama"></small>
      </div>
    </footer>
  </body>
</html>
